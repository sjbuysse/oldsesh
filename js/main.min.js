var module=function(){function e(){(a=new g).init()}var t,o,a,i=document.getElementById("auth-modal"),n=document.getElementById("img-modal"),s=document.getElementById("img-modal__image"),l=document.getElementById("img-modal__caption"),r={},c=function(e,t,o,a,i,n){this.name=ko.observable(e),this.latlng=ko.observable(a),this.info=ko.observable(t),this.id=o,this.editing=ko.observable(!1),this.draggable=ko.observable(i),this.visible=ko.observable(!0),this.selected=ko.observable(!1),this.images=ko.observableArray([]),this.marker=this.createMarker(),n&&(this.placeRef=firebase.database().ref().child("userObjects").child("places").child(n.uid).child(this.id))};c.prototype.createMarker=function(){var e=this,o=new google.maps.Marker({position:e.latlng(),title:e.name(),id:e.id,map:t,draggable:!0,animation:google.maps.Animation.DROP});return ko.computed(function(){o.setVisible(e.visible())}),ko.computed(function(){o.setDraggable(e.draggable())}),ko.computed(function(){o.setPosition(e.latlng())}),ko.computed(function(){e.draggable()?o.setIcon("https://maps.google.com/mapfiles/ms/icons/green-dot.png"):e.selected()?o.setIcon("https://maps.google.com/mapfiles/ms/icons/blue-dot.png"):o.setIcon("https://maps.google.com/mapfiles/ms/icons/red-dot.png")}),o.addListener("click",function(e){return function(){a.setSelectedPlace(e)&&a.populateInfowindow(o)}}(e)),o},c.prototype.setEditing=function(){var e=this;this.editing(!0),this.previousName=this.name(),this.previousInfo=this.info(),this.previousImages=[],this.images().forEach(function(t){e.previousImages.push(t.export())})},c.prototype.setDraggable=function(){this.draggable(!0),this.previousLatLng=this.latlng()},c.prototype.undoEditing=function(){var e=this;this.editing(!1),this.name(this.previousName),this.info(this.previousInfo),this.previousImages.forEach(function(t){e.images().find(function(e){return e.imageKey===t.imageKey}).caption(t.caption)})},c.prototype.saveEditing=function(){var e=this;this.editing(!1),this.placeRef.set(e.export(),function(e){e&&console.log("error: "+e)}),this.images().forEach(function(t){imageRef=firebase.database().ref().child("userObjects").child("images/"+a.user().uid+"/"+e.id+"/"+t.imageKey),imageRef.set(t.export())})},c.prototype.updateLocation=function(){this.draggable(!1);var e={lat:this.marker.getPosition().lat(),lng:this.marker.getPosition().lng()};this.latlng(e),this.placeRef.update({latlng:e})},c.prototype.toPreviousLocation=function(){this.draggable(!1),this.latlng(this.previousLatLng)},c.prototype.export=function(){return{name:this.name(),info:this.info(),id:this.id,latlng:this.latlng()}};var d=function(e,t,o,i,n){this.url=ko.observable(e),this.caption=ko.observable(t),this.name=ko.observable(o),this.placeKey=i,this.imageKey=n,this.imageRef=a.imagesRef.child(i).child(this.imageKey)};d.prototype.export=function(){return{url:this.url(),caption:this.caption(),name:this.name(),imageKey:this.imageKey}};var g=function(){var e=this;this.showDrawer=ko.observable(!1),this.showLargeInfoWindow=ko.observable(!1),this.creatingPlace=ko.observable(!1),this.toggleShowDrawer=function(){0!==e.places().length&&e.selectedPlace()&&e.selectedPlace().draggable()?alert("Please drag and save the green pin before doing something else."):(e.showDrawer(!e.showDrawer()),e.showDrawer&&e.creatingPlace(!1))},this.toggleCreatingPlace=function(){!e.googleDefined||0!==e.places().length&&e.selectedPlace()&&e.selectedPlace().draggable()?e.googleDefined?e.selectedPlace().draggable()&&alert("Please drag and save the green pin before doing something else."):alert("You can't create a new place at the moment, because the google API has trouble loading."):(e.creatingPlace(!e.creatingPlace()),e.creatingPlace&&(e.showDrawer(!1),e.showLargeInfoWindow(!1),e.selectedPlace()&&e.selectedPlace().editing(!1)))},this.toggleShowLargeInfoWindow=function(){e.showLargeInfoWindow(!e.showLargeInfoWindow())},this.filterValue=ko.observable(""),this.createPlace=function(e,t,o,a){return new c(e,t,o,a,!1,this.user())},this.chooseListItem=function(t){e.toggleShowDrawer(),t.marker?google.maps.event.trigger(t.marker,"click"):(e.setSelectedPlace(t),e.showLargeInfoWindow(!0))},this.addLocation=function(){var o=e.newPlace.name(),a={lat:t.getCenter().lat(),lng:t.getCenter().lng()},i=e.newPlace.info(),n=e.placesRef.push().key,s=n,l=e.createPlace(o,i,s,a);this.placesRef.child(n).update(l.export(),function(e){e&&console.log("error: "+e)}),l.setDraggable(),e.toggleCreatingPlace(),e.places.push(l),google.maps.event.trigger(l.marker,"click"),e.newPlace.name(""),e.newPlace.info(""),e.newPlace.id=e.places().length},this.setSelectedPlace=function(e){return e?this.selectedPlace()?this.selectedPlace()===e||(this.selectedPlace().editing()||this.selectedPlace().draggable()?(alert("Please save or cancel the changes you've made to the currently selected place before selecting another."),!1):(this.selectedPlace().selected(!1),this.selectedPlace(e),this.selectedPlace().selected(!0),!0)):(this.selectedPlace(e),this.selectedPlace().selected(!0),!0):(this.selectedPlace(e),!0)},this.removeLocation=function(t){t.placeRef.remove(function(e){e&&console.log("error: "+e)}),t.marker.setVisible(!1),o.close(),o.marker=null,e.places.remove(t),e.setSelectedPlace(null)},this.removeImage=function(t,o){o.imageRef.once("value").then(e.removeSingleImage.bind(e)),t.images.remove(o)},this.populateInfowindow=function(a){if(o.marker!=a){o.marker=a;o.setContent("<div class='info-window' id='infoWindow' data-bind='with: $root.selectedPlace()'><label class='info-window__name' data-bind='text: name'></label><p data-bind='visible: draggable()'>Drag and drop me in the correct location, then press 'Save Location'</p><button data-bind='click: $parent.toggleShowLargeInfoWindow, visible: !draggable()'>Show all info</button><button data-bind='click: setDraggable,visible: (!draggable())'>Move to new location</button><button data-bind='visible: draggable(), click: updateLocation' >Save location</button><button data-bind='visible: draggable(), click: toPreviousLocation' >Reset location</button><button data-bind='confirmClick: {message: &#39; Are you sure you want to delete this place? &#39; , click: $parent.removeLocation}, visible: (!draggable())'>Remove spot</button></div>"),o.open(t,a);a.getPosition().lat(),a.getPosition().lng();ko.applyBindings(e,document.getElementById("infoWindow")),o.addListener("closeclick",function(){o.marker=null})}},this.closeInfoWindow=function(){return e.googleDefined&&o.close(),!0},this.closeImgModal=function(){n.classList.add("hidden")},this.openImgModal=function(e){s.src=e.url(),l.innerHTML=e.caption(),n.classList.remove("hidden")}};return g.prototype.supportFileAPI=function(){return!!(window.File&&window.FileReader&&window.FileList&&window.Blob)},g.prototype.removeUserImages=function(e){var t=this,o=[];return e.forEach(function(e){var a=t.removePlaceImages(e);o.push(a)}),Promise.all(o)},g.prototype.removePlaceImages=function(e){var t=this,o=[];return e.forEach(function(e){var a=t.removeSingleImage(e);o.push(a)}),Promise.all(o)},g.prototype.removeSingleImage=function(e){var t=this,o=e.val().url;return Promise.all([e.ref.remove(),t.removeImageWithUrl(o)])},g.prototype.removeImageWithUrl=function(e){return firebase.storage().refFromURL(e).delete()},g.prototype.handleJSONSelect=function(e,t){var o=this,a=t.target.files[0],i=new FileReader;i.onload=function(e){function t(e){o.placesRef.set(e.places,function(e){e?console.log("error: "+e):location.reload()})}var a=e.target.result,i=JSON.parse(a);o.imagesRef.once("value").then(o.removeUserImages.bind(o)).then(function(){t(i)}).catch(function(e){console.log("An error occured :"+e)})},i.readAsText(a)},g.prototype.handleImageSelect=function(e,t){var o=this,a=document.getElementById("previewImg");this.selectedFile=t.target.files[0],this.resizedImage=null;var i=this.selectedFile.name.match(/\.([^\.]+)$/)[1];switch(i.toLowerCase()){case"jpg":case"jpeg":case"png":case"bmp":break;default:return alert("The file with extension "+i+" is not allowed.\nPlease try again with a jpg, jpeg, png or bmp file."),void this.resetUploadVariables()}var n=new FileReader;n.onload=function(e){a.src=e.target.result,document.getElementById("images-upload-btn").classList.remove("hidden"),document.getElementById("image-caption").classList.remove("hidden"),o.resizedImage&&(o.resizedImage=null),imageResizer.resizeImage(e.target.result,function(e){o.resizedImage=e})},n.readAsDataURL(this.selectedFile)},g.prototype.resetUploadVariables=function(){this.resizedImage=null,this.selectedFile=null,document.getElementById("previewImg").src="",document.getElementById("image-caption").value="",tools.addClass("hidden",document.getElementById("image-caption")),setTimeout(function(){tools.addClass("hidden",document.getElementById("progress-wrapper")),tools.removeClass("hidden",document.getElementsByClassName("upload-image__select-btn")[0])},1500)},g.prototype.uploadImage=function(){function e(e){var t=e.bytesTransferred/e.totalBytes*100;switch(console.log("Upload is "+t+"% done"),o(t),e.state){case firebase.storage.TaskState.PAUSED:console.log("Upload is paused");break;case firebase.storage.TaskState.RUNNING:console.log("Upload is running")}}function t(e){console.log("There occured an error while uploading the file to the server :"+e),a.resetUploadVariables()}function o(e){var t=e/100*200;t=Math.floor(t),document.getElementById("progress-bar").style.width=t+"px",document.getElementById("progress-caption").innerHTML=Math.floor(e)+"% done"}var a=this,i=document.getElementById("images-upload-btn"),n=document.getElementsByClassName("upload-image__select-btn")[0],s=document.getElementById("progress-wrapper");if(tools.addClass("hidden",i),tools.addClass("hidden",n),o(0),tools.removeClass("hidden",s),null===this.resizedImage)return console.log("Image is still resizing, will try again in 1 sec"),void setTimeout(function(e){return function(){e.uploadImage()}}(a),1e3);var l=document.getElementById("image-caption").value,r=this.selectedPlace,c=this.selectedPlace().placeRef.key,g=Date.now(),u=this.storageRef.child("/images/"+c+"/"+g+this.selectedFile.name);uploadTask=u.put(a.resizedImage),uploadTask.on("state_changed",e,t,function(e,t,o){return function(){var i=uploadTask.snapshot.downloadURL,n=a.imagesRef.child(e).push().key,s={url:i,caption:o,name:t,imageKey:n};a.imagesRef.child(e).child(n).update(s),r().images.push(new d(s.url,s.caption,s.name,e,n)),a.resetUploadVariables()}}(c,a.selectedFile.name,l))},g.prototype.exportLocations=function(){var e={places:{}};this.places().map(function(t){e.places[t.export().id]=t.export()}),console.save(ko.toJSON(e),"sessions")},g.prototype.signOut=function(){function e(){i.classList.remove("hidden"),n.userRef=null,n.user(null),n.places().forEach(a),o.close(),o.marker=null,n.places([])}function t(e){console.log("sign out failed because of error: "+e)}function a(e){e.marker.setVisible(!1)}var n=this;firebase.auth().signOut().then(e).catch(t)},g.prototype.init=function(){var e=this;if(e.places=ko.observableArray([]),e.googleDefined=!1,e.user=ko.observable(null),"undefined"!=typeof google&&(e.googleDefined=!0),firebase.auth().onAuthStateChanged(function(t){t?(e.user(t),i.className+=" hidden",e.databaseRef=firebase.database().ref(),e.userRef=e.databaseRef.child("users").child(e.user().uid),e.placesRef=e.databaseRef.child("userObjects").child("places").child(e.user().uid),e.imagesRef=e.databaseRef.child("userObjects").child("images").child(e.user().uid),e.storageRef=firebase.storage().ref().child(e.user().uid),e.placesRef.once("value",function(t){t.forEach(function(t){var o=t.val(),a=t.key,i=e.createPlace(o.name,o.info,a,o.latlng);e.places.push(i),e.imagesRef.child(a).once("value",function(e){return function(t){t.forEach(function(t){var o=t.val();e.images.push(new d(o.url,o.caption,o.name,e.id,o.imageKey))})}}(i))})}),e.placesRef.on("child_removed",function(t){var o=t.key;e.imagesRef.child(o).once("value").then(function(t){e.removePlaceImages(t)})})):(i.classList.remove("hidden"),ui.start("#firebaseui-auth-container",uiConfig))}),e.googleDefined){var o={lat:t.getCenter().lat(),lng:t.getCenter().lng()};e.newPlace=e.createPlace("","",e.places().length,o),e.newPlace.visible(!1)}e.filterPlaces=ko.computed(function(){var t=e.filterValue().toLowerCase();e.places().forEach(function(e){e.name().toLowerCase().indexOf(t)>-1?e.visible(!0):e.visible(!1)})}),e.selectedPlace=ko.observable(e.places()[0]),ko.applyBindings(a)},r.getUser=function(){a.user&&console.log("true")},r.initWithoutMap=function(){e(),document.getElementById("map").innerHTML="<p>It seems like we couldn't load the google maps API, you can still browse around the spots and read and the place information, but you won't be able to add any new places</p>"},r.initMap=function(){var a={zoom:5,center:{lat:-40.900557,lng:174.885971},mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.HORIZONTAL_BAR,position:google.maps.ControlPosition.TOP_CENTER},zoomControl:!0,zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_CENTER},scaleControl:!0,streetViewControl:!0,streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_CENTER}},i=document.getElementsByTagName("head")[0],n=i.insertBefore;i.insertBefore=function(e,t){e.href&&0===e.href.indexOf("https://fonts.googleapis.com/css?family=Roboto")?console.info("Prevented Roboto from loading!"):(console.log(e),n.call(i,e,t))},t=new google.maps.Map(document.getElementById("map"),a),o=new google.maps.InfoWindow,e()},r}();